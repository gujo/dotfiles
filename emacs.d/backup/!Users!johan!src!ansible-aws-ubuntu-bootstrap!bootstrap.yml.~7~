---
- hosts: newservers
  remote_user: ubuntu
  sudo: yes
  
  vars:
    - ubuntu_release: precise
    - root_password: ''
    - deploy_password: ''

  tasks:

    # First make sure all is updated and enable unattended security updates

    - name: update apt cache
      action: apt update_cache=yes

    - name: update apt to latest version
      action: apt upgrade=safe

    - name: Adjust APT update intervals
      action: copy src=config/apt_periodic dest=/etc/apt/apt.conf.d/10periodic
             
    - name: Make sure unattended-upgrades only installs from {{ ubuntu_release }}-security
      action: lineinfile dest=/etc/apt/apt.conf.d/50unattended-upgrades regexp="{{ ubuntu_release }}-updates" state=absent
      
    # Comment
      
    - name: Disallow password authentication
      action: lineinfile dest=/etc/ssh/sshd_config regexp="^PasswordAuthentication" line="PasswordAuthentication no" state=present
      notify: Restart ssh

    - name: Disallow root SSH access
      lineinfile: dest=/etc/ssh/sshd_config regexp="^PermitRootLogin" line="PermitRootLogin no" state=present
      notify: Restart ssh

    - name: Disallow password authentication
      lineinfile: dest=/etc/ssh/sshd_config regexp="^PasswordAuthentication" line="PasswordAuthentication no" state=present
      notify: Restart ssh
